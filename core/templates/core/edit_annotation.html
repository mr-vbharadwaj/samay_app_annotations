{% extends 'base.html' %}

{% block content %}
<h2>Edit Annotation</h2>
<div class="annotation-container">
    <img src="{{ image_url }}" alt="Image to annotate" id="annotationImage">
    <canvas id="annotationCanvas"></canvas>
</div>
<div id="annotationControls">
    <button id="saveAnnotation">Save Changes</button>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const image = document.getElementById('annotationImage');
    const canvas = document.getElementById('annotationCanvas');
    const ctx = canvas.getContext('2d');
    const saveButton = document.getElementById('saveAnnotation');

    let annotations = "{{ annotation.data|safe }}";

    function resizeCanvas() {
        canvas.width = image.width;
        canvas.height = image.height;
    }

    function drawAnnotations() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        annotations.forEach((point, index) => {
            ctx.beginPath();
            ctx.arc(point.x, point.y, 5, 0, 2 * Math.PI);
            ctx.fillStyle = 'red';
            ctx.fill();
            ctx.fillStyle = 'white';
            ctx.font = '12px Arial';
            ctx.fillText(index + 1, point.x - 3, point.y + 4);
        });
    }

    image.onload = function() {
        resizeCanvas();
        drawAnnotations();
    };
    window.addEventListener('resize', function() {
        resizeCanvas();
        drawAnnotations();
    });

    canvas.addEventListener('click', function(event) {
        const rect = canvas.getBoundingClientRect();
        const x = event.clientX - rect.left;
        const y = event.clientY - rect.top;
        annotations.push({x, y});
        drawAnnotations();
    });

    canvas.addEventListener('contextmenu', function(event) {
        event.preventDefault();
        const rect = canvas.getBoundingClientRect();
        const x = event.clientX - rect.left;
        const y = event.clientY - rect.top;
        
        for (let i = annotations.length - 1; i >= 0; i--) {
            const point = annotations[i];
            const distance = Math.sqrt((x - point.x) ** 2 + (y - point.y) ** 2);
            if (distance <= 5) {
                annotations.splice(i, 1);
                drawAnnotations();
                break;
            }
        }
    });

    saveButton.addEventListener('click', function() {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        fetch('{% url "edit_annotation" annotation.id %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
            },
            body: JSON.stringify({
                annotation_data: annotations
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('Annotation updated successfully!');
            } else {
                alert('Error updating annotation: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while updating the annotation.');
        });
    });
});
</script>
{% endblock %}