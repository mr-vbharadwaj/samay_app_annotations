{% extends 'base.html' %}

{% block title %}Batch Annotation{% endblock %}

{% block extra_head %}
<style>
    #annotationCanvas {
        border: 1px solid #000;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto bg-white rounded-xl shadow-md overflow-hidden">
    <div class="p-8">
        <h2 class="text-2xl font-bold mb-4">Batch Annotation: {{ batch.name }}</h2>
        <p class="text-gray-600 mb-4">{{ batch.description }}</p>
        
        {% if page_obj %}
            <div class="mb-8">
                <img id="currentImage" src="{{ page_obj.object.file.url }}" alt="Image to annotate" class="max-w-full h-auto hidden">
                <canvas id="annotationCanvas"></canvas>
            </div>
            
            <div class="flex justify-between items-center mb-4">
                <span>Image {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
                <div>
                    {% if page_obj.has_previous %}
                        <a href="?page={{ page_obj.previous_page_number }}" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded mr-2">Previous</a>
                    {% endif %}
                    {% if page_obj.has_next %}
                        <a href="?page={{ page_obj.next_page_number }}" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Next</a>
                    {% endif %}
                </div>
            </div>
            
            <button id="saveAnnotation" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Save Annotation</button>
        {% else %}
            <p class="text-gray-500">No images in this batch.</p>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const canvas = document.getElementById('annotationCanvas');
    const ctx = canvas.getContext('2d');
    const img = document.getElementById('currentImage');
    let isDrawing = false;
    let lastX = 0;
    let lastY = 0;
    
    img.onload = function() {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
    };
    
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);
    
    function startDrawing(e) {
        isDrawing = true;
        [lastX, lastY] = [e.offsetX, e.offsetY];
    }
    
    function draw(e) {
        if (!isDrawing) return;
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(e.offsetX, e.offsetY);
        ctx.stroke();
        [lastX, lastY] = [e.offsetX, e.offsetY];
    }
    
    function stopDrawing() {
        isDrawing = false;
    }
    
    document.getElementById('saveAnnotation').addEventListener('click', function() {
        const annotationData = canvas.toDataURL();
        const imageId = {{ page_obj.object.id }};
        
        fetch(`/api/save-annotation/${imageId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: JSON.stringify({ annotation_data: annotationData }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('Annotation saved successfully!');
            } else {
                alert('Error saving annotation');
            }
        });
    });
</script>
{% endblock %}

